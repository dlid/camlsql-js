!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():e.camlsql=t()}(this,function(){"use strict";function e(e){var t,r=0;if("string"!=typeof e)throw"[camlsql] Interval value must be a string";if(e=e.toLowerCase(),t=e.match(/^(\d+) (day|hour|minute|second|ms|millisecond)s?$/i)){switch(e=parseInt(e,10),t[2]){case"day":r=24*e*60*60;break;case"hour":r=60*e*60;break;case"minute":r=60*e;break;case"second":r=e;break;case"ms":case"millisecond":r=e/1e3}return 1e3*r}throw"[camlsql] Interval string was not recognized: "+e}function t(e,t){var l;return e=y(e.toLowerCase()),t=t?new Date(+t):new Date,"month start"==e?l=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0):"month end"==e?l=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999):"week start"==e?l=r(t):"week start monday"==e?l=r(t,!0):"week end monday"==e?l=n(t,!0):"week end"==e?l=n(t):"day start"==e?l=new Date(t.setHours(0,0,0,0)):"day end"==e&&(l=new Date(t.setHours(23,59,59,999))),l}function r(e,t){(e=e?new Date(+e):new Date).setHours(0,0,0,0),t=!!t;var r=e.getDay();return!0===t&&(0==r?r=6:r-=1),e.setDate(e.getDate()-r),e}function n(e,t){return e=r(e,t),e.getDay(),e.setDate(e.getDate()+6),new Date(e.setHours(23,59,59,999))}function l(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function a(e){if("boolean"!=typeof e&&void 0!==e)throw"[camlsql] Value was not boolean";return{type:"Boolean",value:e}}function i(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a number";return e=e||0,{type:"Number",value:e}}function o(e){var t=s(e);return t&&(t._includeTime=!1),t}function s(e){var t,r=!1;return void 0!==e&&W.isPrototypeOf(e)&&(e=e.value),"string"==typeof e?(t=e+"",e=null):(e||(r=!0),e=e?new Date(+e):new Date),Object.create(W,{type:{value:"DateTime"},value:{value:e,writable:!0},_includeTime:{value:!0,writable:!0},today:{value:r,writable:!0},_storageTZ:{value:!0,writable:!0},stringValue:{value:t,writable:!1}})}function u(e,t){if(void 0===e&&(e=0),"number"!=typeof e)throw"[camlsql] Bad offset value for 'today'";return{type:"DateTime",today:!0,value:e,_includeTime:!0===t}}function c(e){return{type:"Guid",value:e}}function f(e){return{type:"MultiChoice",value:e}}function d(e){return{type:"Choice",value:e}}function m(e){return"number"==typeof e?{type:"User",value:e,lookupid:!0}:{type:"User"}}function h(e){function t(){var t=new SP.CamlQuery,l=e.query.getXml();t.set_viewXml(l),c=s.getItems(t),n.load(c),n.executeQueryAsync(r,function(t,r){var n="";r&&-2130575340==r.get_errorCode()&&(n+=" (Error -2130575340: Check field names)"),o({status:"error",message:"Error executing the SP.CamlQuery"+n,data:{sql:e.query.$options.parsedQuery.query,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)})}function r(){var e,t=c.getEnumerator(),r=[],n=c.get_listItemCollectionPosition();for(n&&(l=n.get_pagingInfo());t.moveNext();)e=t.get_current(),a||(a="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id())),r.push(e.get_fieldValues());o(null,r,{nextPage:l,prevPage:a})}var n,l,a,i=e.spWeb,o=e.callback,s=null,u=e.query.getListName(),c=null,f=e.rawXml?e.rawXml:e.query.getXml();if("function"!=typeof o&&(o=null),"undefined"!=typeof SP)SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){}),SP.SOD.executeOrDelayUntilScriptLoaded(function(){n=SP.ClientContext.get_current(),i||(i=n.get_web(),s=i.get_lists().getByTitle(u),n.load(s),n.executeQueryAsync(t,function(){if(null==o)throw"[camlsql] Failed to load list";o({status:"error",message:"Failed to load list",data:{sql:e.query.$options.parsedQuery.query,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)}))},"sp.js");else{if(null==o)throw"[camlsql] SP is not defined";o({status:"error",message:"SP is not defined",data:null},null)}}function p(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function y(e){return e.replace(/^\s+|\s+$/g,"")}function g(e){return y(e).replace(/^\[|\]$/g,"")}function v(e,t){var r=this,n=_(t);this.exec=function(e){var t,r,n=Array.prototype.slice.call(arguments),l=e.rawXml;return n.length>1?"object"==typeof n[0]&&(t=n[0],"function"==typeof n[1]&&(r=n[1])):1==n.length&&("object"==typeof n[0]?t=n[0]:"function"==typeof n[0]&&(r=n[0])),h({query:this,callback:r,spWeb:t,rawXml:l}),this},this.getListName=function(){return r.$options.parsedQuery.listName},this.getXml=function(){return new P(r).xml},this.$options={parsedQuery:L(e),parameters:n}}function _(e){var t,r,n={};if(e&&e.length>0)for(l=0;l<e.length;l++)(t=w(e[l]))&&(n["@param"+l]=t);else if("object"==typeof e){r=Object.keys(e);for(var l=0;l<r.length;l++)0===r[l].indexOf("@")&&(t=w(e[r[l]]))&&(n[r[l]]=t)}return n}function w(e){var t,r=null;if(null==e)return null;if(null!==e&&e.constructor===Array)for(r=[],t=0;t<e.length;t++)r.push(w(e[t]));else if("string"==typeof e)r=l(e);else if("boolean"==typeof e)r=a(e);else if("number"==typeof e)r=i(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return r}function b(e){var t,r=e.query,n=[];do{if(t=r.match(/\s+(left\s+|)join\s+(\[?[a-zA-Z_\d]+\]?)\son\s(.+?)\.([a-zA-Z_\d]+)(\s|$)/i)){var l=g(t[2]),a=t[3],i=t[4];t[5],t[6];n.push({inner:""==y(t[1]),alias:l,childTable:a,childField:i}),r=r.substr(0,t.index)+" "+r.substr(t.index+t[0].length)+t[5]}}while(t);e.joins=n,e.query=r}function q(e){var t;console.log("WOBJ",e),(t=e.query.match(/\sLIMIT\s(\d+).*$/i))&&(e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10))}function T(e){var t,r,n=[],l=e.query.match(/^SELECT\s(.*?)(?:\sFROM\s(.*?)|)(?:\s+((?:order|where).*)$|$)/i);if(l)if(4==l.length){for(n=k(l[1]),r=0;r<n.length;r++){if(t=n[r].match(/^(.*?)\.(.*?)\sas\s(.*?)$/i))e.projectedFields.push({list:t[1],field:t[2],name:t[3]}),n[r]=g(t[3]);else if(-1!==n[r].indexOf("."))throw"[camlsql] Projected fields in the format <list>.<field_name> must be followed with an AS <alias> ("+n[r]+")";n[r].match(/^[a-z:A-Z_\\d]+$/)||console.warn&&console.warn("[camlsql] Doubtful field name: "+n[r])}e.fields=n,e.listName=g(l[2]),e.query=l[3]}else e.query=""}function k(e){var t,r=[],n=e.split(",");for(t=0;t<n.length;t++)n[t]=g(n[t]),r.push(n[t]);return 1==r.length&&"*"==r[0]&&(r=[]),r}function D(e,t){var r,n,l,a,i,o,s=[],u=e.query,c=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(o=u.match(/\sORDER\sBY\s(.*?)$/i)){if(a=o[1],u=u.substr(0,u.length-o[0].length),void 0!==a&&null!==a)for(;r=c.exec(a);){if(i=!0,l=null,r[1].indexOf(":")>0){if(!(2==(o=r[1].split(":")).length&&o[0].length>0))return[];switch(o[0]=o[0].toLowerCase(),o[0]){case"datetime":o[0]="DateTime";break;case"text":o[0]="Text";break;case"number":o[0]="Number";break;case"datetime":o[0]="DateTime"}l=o[0],r[1]=o[1]}n=g(r[1]),3==r.length&&(i="desc"!=(void 0!==r[2]?y(r[2].toLowerCase()):null)),s.push([n,i,l])}e.sort=s}}function x(e){var t,r,n=e.query;if(t=n.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":r="DefaultValue";break;case"recursive":r="Recursive";break;case"recursiveall":r="RecursiveAll";break;case"filesonly":r="FilesOnly"}if(!r&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==r&&(e.viewScope=r),e.query=t[1]+n.substr(t[1].length+t[2].length)}else e.viewScope=null}function L(e,t){var r,n={query:e,rowLimit:0,fields:[],sort:[],joins:[],viewScope:null,macros:[],statements:[],parameters:[],listName:null,projectedFields:[]};return x(n),q(n),D(n),b(n),T(n),r=B(n.query),n.statements=r.statements,n.macros=r.macros,n.query=e,n}function P(e){var t="",r=e.$options.parsedQuery,n=e.$options.parameters,l=0;return r.uuid=function(e){return l++,e+l},t+=F(r,r.statements,r.sort,n,{errors:[]}),t+=C(r.listName,r.joins),t+=S(r.projectedFields,r.joins),t+=E(r.fields),(t+=O(r.rowLimit))&&(t=V(Z,{Scope:r.viewScope})+t+Q("View")),{xml:t,errors:null}}function O(e){var t="";return e>0&&(t+=V("RowLimit"),t+=e,t+=Q("RowLimit")),t}function S(e,t){var r,n="",l=[];if(e.length>0&&t.length>0){for(n+=V("ProjectedFields"),r=0;r<t.length;r++)l.push(t[r].alias);for(r=0;r<e.length;r++){if(-1==l.indexOf(e[r].list))throw"[camlsql] Uknown list alias: "+e[r].list;n+=V("Field",{Name:e[r].name,List:e[r].list,Type:"Lookup",ShowField:e[r].field},!0)}n+=Q("ProjectedFields")}return n}function C(e,t){var r,n="";if(t.length>0){for(n+=V("Joins"),r=0;r<t.length;r++)n+=V("Join",{ListAlias:t[r].alias}),n+=V("Eq"),n+=V("FieldRef",{List:t[r].childTable!=e?t[r].childTable:null,Name:t[r].childField,RefType:"Id"},!0),n+=V("FieldRef",{List:t[r].alias,Name:"Id"},!0),n+=Q("Eq"),n+=Q("Join");n+=Q("Joins")}return n}function j(e){var t="";if(e.length>0){t+=V(H);for(var r=0;r<e.length;r++)t+=V(X,{Name:e[r][0],Type:e[r][2]?e[r][2]:null,Ascending:e[r][1]?null:"False"},!0);t+=Q(H)}return t}function F(e,t,r,n,l){var a="";return console.log("PARSED",e,n),(t.length>0||r.length>0)&&(a+=V(z),t.length>0&&(a+=V(Y),a+=I(e,t,n,l),a+=Q(Y)),a+=j(r,n,l),a+=Q(z)),a}function I(e,t,r,n){var l="";if(!t)return"";if(t.length>1){var a="and"==t[1].operator?"And":"Or";return l+=N(e,t[0],r,n),l+=I(e,t.slice(1),r,n),"<"+a+">"+l+"</"+a+">"}return 1==t.length&&(l+=N(e,t[0],r,n)),l}function N(e,t,r,n){var l,a,i="",o=t.comparison;if("statement"==t.type){l=r[t.macro];var s={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"Lt",ne:"Neq"};if(void 0!==s[o]){if(void 0===l)throw"[camlsql] Parameter is not defined "+t.macro;i+=V(s[o]),i+=A(e,t,l),i+=Q(s[o])}else if("null"==o)i+=V(J),i+=A(e,t),i+=Q(J);else if("notnull"==o)i+=V(G),i+=A(e,t),i+=Q(G);else if("like"==o){if(void 0===l)throw"[camlsql] Parameter is not defined "+t.macro;i+=V(a=$(l.value)),i+=A(e,t,l),i+=Q(a)}}else i+=I(e,t.items,r,n);return i}function $(e){var t="Contains";if(0===e.indexOf("%")&&"%"===e[e.length-1])e.replace(/^%?|%?$/g,"");else{if(0===e.indexOf("%"))throw"[casql] SharePoint does not support an 'EndsWith' statement: "+e;e.indexOf("%")===e.length-1&&(e.replace(/%?$/,""),t="BeginsWith")}return t}function A(e,t,r,n){var l,a="",i=null,o=t.field;if(r&&r.lookupid&&(i="True"),-1!==t.field.indexOf(".")){var s=t.field.split("."),u=!0,c=!0;for(l=0;l<e.projectedFields.length;l++)e.projectedFields[l].list==g(s[0])&&e.projectedFields[l].field==g(s[1])&&(o=e.projectedFields[l].name,u=!1);if(u){for(l=0;l<e.joins.length;l++)if(e.joins[l].alias==s[0]){c=!1;break}if(c)throw"[camlsql] Unknown list alias in where clause: "+s[0];if(0==e.fields.length)throw"[camlsql] The projected field '"+t.field+"' must be explicitly included in the query";o=e.uuid("camlsqlfld_"),e.projectedFields.push({list:s[0],field:s[1],name:o}),e.fields.push(o)}}return a+=V(X,{Name:o,LookupId:i},!0),r&&("in"==t.comparison?a="<In>x</In>":a+=R(t,r)),a}function R(e,t){var r="",n="",l={Type:t.type};return"DateTime"==t.type?(l.IncludeTimeValue=t._includeTime?"True":null,!0===t.today?n="<Today />":!0===t.isNow?n="<Now />":(l.StorageTZ=t._storageTZ?"True":null,n=t.stringValue?p(t.stringValue):t.value.toISOString())):"Text"==t.type?n=1==t.multiline?"<![CDATA["+p(t.value)+"]]>":p(t.value):"Number"==t.type?n=t.value:"User"==t.type?"number"==typeof t.value?(l.Type="Number",l.LookupId="True",n=p(t.value+"")):(l.Type="Number",n="<UserID />"):"Lookup"==t.type?(1==t.byId&&(l.LookupId="True"),n=p(t.value+"")):n="Boolean"==t.type?t.value?1:0:V("NotImplemented",{},!0),r+=V("Value",l),r+=n,r+=Q("Value")}function E(e){var t,r="";if(e.length>0){for(r+=V(M),t=0;t<e.length;t++){if(!e[t].match(/^[a-zA-Z_\d]+$/i))throw"[camlsql] Invalid syntax: "+e[t];r+=V(X,{Name:e[t]},!0)}r+=Q(M)}return r}function V(e,t,r){var n,l="<"+e,a=t?Object.keys(t):[];for(n=0;n<a.length;n++)void 0!==t[a[n]]&&null!==t[a[n]]&&(l+=" "+a[n]+'="'+p(t[a[n]])+'"');return l+(r?" /":"")+">"}function Q(e){return"</"+e+">"}var U,W={type:"DateTime",today:!1,_includeTime:!1,value:null,_storageTZ:!0,stringValue:"",add:function(t){this.errstr();var r=e(t);return this.value=new Date(this.value.getTime()+r),this.today=!1,this},sub:function(t){this.errstr();var r=e(t);return this.value=new Date(this.value.getTime()-r),this.today=!1,this},startOfWeek:function(e){return this.errstr(),this.value=t("week start"+(e?"":" monday"),this.value),this.today=!1,this},endOfWeek:function(e){return this.errstr(),this.value=t("week end"+(e?"":" monday"),this.value),this.today=!1,this},startOfMonth:function(){return this.errstr(),this.value=t("month start",this.value),this.today=!1,this},endOfMonth:function(){return this.errstr(),this.value=t("month end",this.value),this.today=!1,this},endOfDay:function(){return this.errstr(),this.value=t("day end",this.value),this.today=!1,this},startOfDay:function(){return this.errstr(),this.value=t("day start",this.value),this.today=!1,this},storageTZ:function(e){return this._storageTZ=!!e,this.today=!1,this},includeTime:function(e){return this._includeTime=!!e,this},errstr:function(){if(this.stringValue)throw"[camlsql] You can't do that when DateTime was set as a string"}},B=function(e,t){function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var o,s,u,c,f,d,m,h,p,y=null,g=null,v=[],_=0;for(console.log("parse_blocks",e),o=0;o<e.length;o++)e[o]==a?(0==_&&(o>0&&v.push(e.substring(0,o)),y=o,g=null),_++):e[o]==i&&null!==y&&0==--_&&(v.push(r(e.substring(y,o+1)).replace(/^\(|\)$/g,"")),g=o+1);for(console.log("parse_blocks","blocks=",v),null!=g?v.push(r(e.substring(g))):0==v.length&&null==y&&null==g&&v.push(r(e)),o=0;o<v.length;o++)if(s="and",v[o].match(/^\s*(\|\||(or))\s*/i)&&(s="or"),v[o].match(/\s*(?:\|\||(or))\s*$/gi)&&o<v.length-1&&(v[o+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(v[o+1]="or "+v[o+1])),v[o]=v[o].replace(/\s*(\&\&|and)\s*$/i,""),v[o]=v[o].replace(/\s*(\|\||or)\s*$/i,""),v[o]=v[o].replace(/^\s*(\&\&|and)\s*/i,""),v[o]=v[o].replace(/^\s*(\|\||or)\s*/i,""),v[o]={type:"statement",value:v[o],operator:s},v[o].value.indexOf(a)>0)c=n(v[o].value),console.log("childBlocks",c.length),c.length>1&&(v[o].type="group",v[o].items=c);else{for(u=v[o].value.split(/ (\|\||or|and|\&\&) /i),v[o].type="statement",f=[],d=0;d<u.length;d++)if(m={type:"statement",operator:"and"},""!=r(u[d])&&"and"!=u[d].toLowerCase()&&"or"!=u[d].toLowerCase()&&"||"!=u[d]&&"&&"!=u[d])if(d>0&&("or"!=u[d-1].toLowerCase()&&"||"!=u[d-1]||(m.operator="or")),h=l(u[d]))m.field=h.field,m.macro=h.macro,m.comparison=h.comparison,f.push(m);else if(!t)throw"[casql] Could not parse statement: "+u[d];f.length>1?(v[o].type="group",v[o].items=f):1==f.length&&(v[o].field=f[0].field,v[o].macro=f[0].macro,v[o].comparison=f[0].comparison)}for(p=[],o=0;o<v.length;o++)v[o].value&&p.push(v[o]);return p}function l(e){if(void 0===e)return null;var n=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(n){var l="eq",a="@param"+u,i=r(n[2]);if(">"==i&&(l="gt"),">="==i&&(l="gte"),"<"==i&&(l="lt"),"<="==i&&(l="lte"),"=="==i&&(l="eq"),"<>"!=i&&"!="!=i||(l="ne"),"like"==i.toLowerCase()&&(l="like"),"isnull"==i.toLowerCase()&&(l="null"),"isnotnull"==i.toLowerCase()&&(l="notnull"),"in"==i.toLowerCase()&&(l="in"),"null"!=l&&"notnull"!=l){if(u++,c++,null==o)o=n[3];else if(o!=n[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==n[3][0]&&(a=n[3]),f.push(a)}else a=null;return{field:g(n[1]),comparison:l,macro:a}}return null}var a="(",i=")",o=null,s={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return s;var u=0,c=0,f=[],d=n(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==d&&(s.statements=d),s.macroType=o,s.macroCount=c,s.macros=f,s},Z="View",M="ViewFields",X="FieldRef",z="Query",H="OrderBy",Y="Where",J="IsNull",G="IsNotNull";return U={prepare:function(e,t){return new v(e,t)},text:l,guid:c,number:i,lookup:function(e){return{type:"Lookup",value:e,lookupid:"number"==typeof e,byId:"number"==typeof e}},date:o,datetime:s,today:u,multichoice:f,choice:d,user:m,boolean:a},U.__testonly__=U.__testonly__||{},U.__testonly__.padString=function(e,t){for(var r=String(e);r.length<(t||2);)r="0"+r;return r},U.__testonly__.extractOrderByPart=D,U.__testonly__.extractListAndFieldNameParts=T,U.__testonly__.extractScopePart=x,U.__testonly__.extractLimitPart=q,U.__testonly__.parseSqlQuery=L,U.__testonly__.whereParser=B,U.__testonly__.createDateParameter=o,U.__testonly__.createDateTimeParameter=s,U.__testonly__.createTodayParameter=u,U.__testonly__.createGuidParameter=c,U.__testonly__.createMultiChoiceParameter=f,U.__testonly__.createChoiceParameter=d,U.__testonly__.createUserParameter=m,U.__testonly__.encodeHTML=p,U.__testonly__.trim=y,U.__testonly__.formatFieldName=g,U.__testonly__.getIntervalStringAsMs=e,U.__testonly__.createDateWithIntervalString=function(t){var r=e(t);return new Date((new Date).getTime()+r)},U.__testonly__.getDateFromTextualRepresentation=t,U.__testonly__.getStartOfWeek=r,U.__testonly__.getEndOfWeek=n,U.__testonly__.executeSPQuery=h,U});